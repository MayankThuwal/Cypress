name: Cypress QA-Environment Tests

on:
  workflow_dispatch: # allows manual run from Actions tab
  schedule:
    # Every day at 7:00 AM IST (1:30 AM UTC)
    - cron: '30 1 * * *'

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: KloudShip.Automation.Cypress.ECSLite  #All steps will execute from repo root

    steps:
      # Checkout repository (mandatory)
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # Install dependencies from your existing package.json
      - name: Install Dependencies
        run: npm ci
      # Reports are generated because reporter is inside your project package.json

      - name: Ensure report directory exists
        run: mkdir -p cypress/reports

      # Run Cypress test for QA environment
      - name: Run Cypress Test
        run: npx cypress  run --env ENV=qa --spec "cypress/e2e/order/order-review.cy.ts" --reporter cypress-mochawesome-reporter

      - name: DEBUG â€” Show Mochawesome Output
        if: always()
        run: |
          echo "=== ROOT FOLDER ==="
          ls -R .
          echo "=== CYPRESS FOLDER ==="
          ls -R cypress || echo "No cypress folder"
          echo "=== REPORTS FOLDER ==="
          ls -R cypress/reports || echo "No reports folder OR no json files"
      
      # Some folders contain nested JSON, so use **/*.json
      - name: Merge Mochawesome JSON
        if: always()
        run: |
          npx mochawesome-merge cypress/reports/**/*.json > cypress/reports/report.json

      - name: Generate Mochawesome HTML Report
        if: always()
        run: |
          npx marge cypress/reports/report.json --reportDir cypress/reports

      # Upload Cypress HTML Report (always)
      # - name: Upload Cypress HTML Report
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: cypress-html-report
      #     path: cypress/reports
