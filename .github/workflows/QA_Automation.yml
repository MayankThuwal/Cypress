name: Cypress QA-Environment Tests

on:
  workflow_dispatch: # allows manual run from Actions tab
  schedule:
    # Every day at 7:00 AM IST (1:30 AM UTC)
    - cron: '30 1 * * *'

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    defaults:
      run:
        # Ensures all commands run inside the Cypress project folder
        working-directory: KloudShip.Automation.Cypress.ECSLite 

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # Install all dependencies inside the working directory.
      - name: Install All Dependencies
        run: npm install

      # NEW STEP 1: Install wkhtmltopdf utility for PDF conversion
      - name: Install wkhtmltopdf
        run: |
          sudo apt-get update
          sudo apt-get install -y wkhtmltopdf

      - name: Ensure report directory exists
        run: mkdir -p cypress/reports

      # Added 'reportDir=cypress/reports' to ensure the JSON output goes to the right place.
      - name: Run Cypress Test
        run: npx cypress run --env ENV=qa --reporter mochawesome --reporter-options "reportDir=cypress/reports,reportFilename=chrome-results,overwrite=true,html=false,json=true" --spec "cypress/e2e/order/order-review.cy.ts"
        
      # Copy the single generated JSON file to a standard name for 'marge'.
      - name: Copy/Rename Mochawesome JSON
        if: always()
        run: cp cypress/reports/chrome-results.json cypress/reports/report.json

      # Generate the final Mochawesome HTML Report.
      - name: Generate Mochawesome HTML Report
        if: always()
        run: npx marge cypress/reports/report.json --reportDir cypress/reports --inline

      - name: Generate PDF Report
        if: always()
        run: wkhtmltopdf cypress/reports/report.html cypress/reports/report.pdf

      # # Configure AWS credentials
      # - name: Configure AWS Credentials
      #   if: always()
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: ${{ secrets.AWS_REGION }}

      # Configure AWS credentials
      - name: Configure AWS Credentials
        if: always()
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: AKIAZ24ITALM5JBONW6G
          aws-secret-access-key: 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
          aws-region: ap-south-1

      # Upload to S3 Bucket
      - name: Upload PDF to S3
        if: always()
        run: |
          aws s3 cp cypress/reports/report.pdf s3://mayank-test-987/cypress-reports/$(date +'%Y-%m-%d_%H-%M')-report.pdf
