name: Cypress QA-Environment Tests

on:
  workflow_dispatch: # allows manual run from Actions tab
  schedule:
    # Every day at 7:00 AM IST (1:30 AM UTC)
    - cron: '30 1 * * *'

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    defaults:
      run:
        # All run steps will execute from inside this folder
        working-directory: KloudShip.Automation.Cypress.ECSLite 

    steps:
      # ... (Checkout and Setup Node.js steps are fine) ...
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # FIX 1: Explicitly install the core project dependencies AND the reporter packages.
      - name: Install Dependencies and Reporters
        run: |
          # Install existing dependencies from package.json
          npm install

      - name: Ensure report directory exists
        run: mkdir -p cypress/reports

      # This step is correct: uses the installed mochawesome and reporter-options for JSON output.
      - name: Run Cypress Test
        run: npx cypress run --env ENV=qa --reporter mochawesome --reporter-options "reportFilename=chrome-results,overwrite=true,html=false,json=true" --spec "cypress/e2e/order/order-review.cy.ts"
        
      # Since only one spec is run, we just copy the output file to the expected report name.
      - name: Merge/Rename Mochawesome JSON
        if: always()
        run: |
          # Copy the single generated JSON file and rename it for the 'marge' step.
          cp cypress/reports/chrome-results.json cypress/reports/report.json

      # Generate the final Mochawesome HTML Report using the merged JSON.
      - name: Generate Mochawesome HTML Report
        if: always()
        run: |
          npx marge cypress/reports/report.json --reportDir cypress/reports --inline

      # Upload Cypress HTML Report (always)
      - name: Upload Cypress HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-html-report
          path: cypress/reports/report.html
